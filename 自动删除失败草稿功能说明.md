# 自动删除失败草稿功能说明

## 功能概述

当推文发布失败时，系统可以自动删除相关的草稿文件，避免累积无效的草稿。这个功能是可配置的，用户可以根据需要启用或禁用。

## 功能特性

### ✅ 支持的操作类型
- 单条推文发布失败
- 推文串发布失败（包括部分发布成功的情况）
- 回复推文发布失败
- 引用转发发布失败
- 带媒体推文发布失败

### ✅ 错误处理场景
- Twitter API 错误（如网络问题、API限制等）
- 媒体文件不存在或损坏
- 推文内容格式错误
- 认证失败
- 其他系统错误

## 配置选项

### 默认行为
- **默认状态**：启用（`AUTO_DELETE_FAILED_DRAFTS=true`）
- **启用时**：发布失败后自动删除草稿
- **禁用时**：发布失败后保留草稿，允许手动重试

### 配置方法

#### 方法1：环境变量配置
在您的配置文件中添加环境变量：

```json
{
  "env": {
    "AUTO_DELETE_FAILED_DRAFTS": "true"  // 启用自动删除
    // 或
    "AUTO_DELETE_FAILED_DRAFTS": "false" // 禁用自动删除
  }
}
```

#### 方法2：运行时配置
使用以下命令动态配置：

```
启用发布失败时自动删除草稿功能
```

```
禁用发布失败时自动删除草稿功能
```

#### 方法3：查看当前配置
```
查看当前自动删除草稿的配置状态
```

## 使用场景

### 推荐启用的情况
- 频繁创建和发布推文
- 希望保持草稿文件夹整洁
- 不需要手动重试失败的推文
- 自动化推文发布流程

### 推荐禁用的情况
- 需要分析发布失败的原因
- 希望手动修改和重试失败的推文
- 调试推文发布问题
- 重要推文需要确保发布成功

## 行为详情

### 启用自动删除时
1. 尝试发布草稿
2. 如果发布失败，自动删除草稿文件
3. 返回错误信息，提示"草稿已被删除"
4. 记录删除操作到日志

### 禁用自动删除时
1. 尝试发布草稿
2. 如果发布失败，保留草稿文件
3. 返回错误信息，提示"草稿已保留用于重试"
4. 用户可以稍后重新尝试发布

### 特殊情况：推文串部分发布
当推文串发布过程中部分成功时：
- **启用自动删除**：删除草稿，记录已发布的推文ID
- **禁用自动删除**：保留草稿，记录已发布的推文ID
- 无论哪种情况，都会在错误信息中显示已成功发布的推文ID

## 日志记录

系统会记录以下操作：
- 草稿删除操作（成功/失败）
- 配置更改操作
- 发布失败的详细错误信息

## 故障排除

### 常见问题

**Q: 配置更改后没有生效？**
A: 确保重新启动了MCP服务器，或者使用运行时配置命令。

**Q: 草稿删除失败怎么办？**
A: 检查文件权限，确保程序有删除草稿文件的权限。

**Q: 如何恢复被自动删除的草稿？**
A: 被自动删除的草稿无法恢复。如果需要保留失败的草稿，请禁用自动删除功能。

**Q: 推文串部分发布成功，草稿被删除了，如何继续？**
A: 查看错误信息中的已发布推文ID，可以手动创建新的推文来继续推文串。

## 最佳实践

1. **测试环境**：在测试时建议禁用自动删除，便于调试
2. **生产环境**：在稳定的生产环境中可以启用自动删除
3. **重要推文**：对于重要推文，建议先禁用自动删除，确保发布成功后再启用
4. **定期检查**：定期检查草稿文件夹，清理不需要的草稿

## 技术实现

### 配置持久化
- 运行时配置会自动更新 `.env` 文件（如果存在）
- 配置更改会立即生效，无需重启

### 错误处理优先级
1. 尝试发布草稿
2. 捕获发布错误
3. 根据配置决定是否删除草稿
4. 记录操作日志
5. 返回详细错误信息

### 安全考虑
- 删除操作有异常处理，避免程序崩溃
- 删除失败时会记录错误日志
- 不会删除非草稿文件